import"./modulepreload-polyfill-B5Qt9EMX.js";import{p as h,r as v}from"./topBar-DJwU6RwO.js";const u="https://www.relda.com.br",w=JSON.parse(localStorage.getItem("userData"));let i=null;document.addEventListener("DOMContentLoaded",()=>{h("cadastros"),v("cadastros",w.permissions_list),x(),y()});const p=e=>{const t=parseFloat(e);return isNaN(t)?"R$ 0,00":t.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})};async function x(){try{document.getElementById("openModalBtn").addEventListener("click",B),document.getElementById("cancelBtn").addEventListener("click",g),document.getElementById("creditCardForm").addEventListener("submit",C),document.getElementById("confirm-delete-btn").addEventListener("click",b),document.getElementById("cancel-delete-btn").addEventListener("click",f)}catch(e){console.error("Falha ao carregar o componente do modal:",e)}}async function y(){const e=document.getElementById("cards-table-body"),t=document.getElementById("active-cards-count"),n=document.getElementById("total-limit"),d=document.getElementById("next-due-date");try{const o=await fetch(`${u}/api/finance/credit-cards/`,{credentials:"include"});if(o.status===401){window.location.href="../login.html";return}if(!o.ok)throw new Error("Falha ao buscar os cartões de crédito. Tente fazer login novamente.");const r=await o.json();if(e.innerHTML="",r.length===0){e.innerHTML='<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhum cartão cadastrado.</td></tr>',t.textContent=0,n.textContent=p(0),d.textContent="-";return}let c=0,s=0;r.forEach(a=>{a.is_active&&(c++,s+=parseFloat(a.credit_limit))}),t.textContent=c,n.textContent=p(s);const m=r.filter(a=>a.is_active).sort((a,l)=>a.due_day-l.due_day).find(a=>a.due_day>=new Date().getDate())||r.find(a=>a.is_active);m&&(d.textContent=`Dia ${m.due_day}`),r.forEach(a=>{const l=document.createElement("tr");l.innerHTML=`
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${a.name}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${a.brand}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">**** ${a.last_digits}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p(a.credit_limit)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Todo dia ${a.due_day}</td>
        <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${a.is_active?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}">
                ${a.is_active?"Ativo":"Inativo"}
            </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="openEditModal(${a.id})" class="text-blue-600 hover:text-blue-800 mr-3">
                <i class="fas fa-edit"></i>
            </button>
              <button onclick="openDeleteModal(${a.id})" class="text-red-500 hover:text-red-700">
            <i class="fas fa-trash-alt"></i>
        </button>
            </td>
    `,e.appendChild(l)})}catch(o){console.error("Erro ao renderizar cartões:",o),alert(o.message)}}function B(){const e=document.getElementById("creditCardForm");if(e){e.reset(),document.getElementById("modalTitle").textContent="Cadastrar Cartão",i=null;const t=document.getElementById("cardId");t&&(t.value=""),E(),document.getElementById("creditCardModal").classList.remove("hidden")}}async function I(e){i=e;try{const t=await fetch(`${u}/api/finance/credit-cards/${e}/`,{credentials:"include"});if(t.status===401){window.location.href="../login.html";return}if(!t.ok)throw new Error("Não foi possível carregar os dados do cartão.");const n=await t.json();await E();const d=document.getElementById("creditCardModal");document.getElementById("modalTitle").textContent="Editar Cartão de Crédito",document.getElementById("cardId").value=n.id,document.getElementById("cardName").value=n.name,document.getElementById("cardBrand").value=n.brand,document.getElementById("lastDigits").value=n.last_digits,document.getElementById("creditLimit").value=parseFloat(n.credit_limit).toFixed(2).replace(".",","),document.getElementById("closingDay").value=n.closing_day,document.getElementById("dueDay").value=n.due_day,document.getElementById("associatedAccount").value=n.associated_account,document.getElementById("cardStatus").checked=n.is_active,d.classList.remove("hidden")}catch(t){alert(t.message)}}async function C(e){e.preventDefault();const t=i,n={name:document.getElementById("cardName").value,brand:document.getElementById("cardBrand").value,last_digits:document.getElementById("lastDigits").value,credit_limit:document.getElementById("creditLimit").value.replace(/\./g,"").replace(",","."),closing_day:document.getElementById("closingDay").value,due_day:document.getElementById("dueDay").value,associated_account:document.getElementById("associatedAccount").value,is_active:document.getElementById("cardStatus").checked},d=t?`${u}/api/finance/credit-cards/${t}/`:`${u}/api/finance/credit-cards/`,o=t?"PUT":"POST",r=document.querySelector('button[type="submit"][form="creditCardForm"]');r.disabled=!0,r.textContent="Salvando...";try{const c=await fetch(d,{method:o,headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)});if(!c.ok){const s=await c.json();let m="Erro ao salvar: ";for(const a in s){const l=Array.isArray(s[a])?s[a].join(", "):s[a];m+=`${a}: ${l} `}throw new Error(m)}alert(t?"Cartão atualizado com sucesso!":"Cartão criado com sucesso!"),g(),y()}catch(c){alert(c.message)}finally{r.disabled=!1,r.textContent="Salvar"}}async function b(){if(i)try{if((await fetch(`${u}/api/finance/credit-cards/${i}/`,{method:"DELETE",credentials:"include"})).status!==204)throw new Error("Erro ao excluir o cartão.");alert("Cartão excluído com sucesso!"),f(),y()}catch(e){alert(e.message)}}function g(){const e=document.getElementById("creditCardModal");e&&e.classList.add("hidden")}function _(e){i=e,document.getElementById("delete-modal").classList.remove("hidden")}function f(){i=null,document.getElementById("delete-modal").classList.add("hidden")}async function E(){const e=document.getElementById("associatedAccount");if(e)try{const t=await fetch(`${u}/api/finance/bank-accounts/`,{credentials:"include"});if(t.status===401){window.location.href="../login.html";return}if(!t.ok)throw new Error("Falha ao carregar contas.");const n=await t.json();e.innerHTML='<option value="">Selecione uma conta</option>',n.filter(d=>d.is_active).forEach(d=>{const o=document.createElement("option");o.value=d.id,o.textContent=d.name,e.appendChild(o)})}catch(t){console.error("Erro ao popular contas:",t),e.innerHTML='<option value="">Erro ao carregar contas</option>'}}window.openEditModal=I;window.openDeleteModal=_;
