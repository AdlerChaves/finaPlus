import"./modulepreload-polyfill-B5Qt9EMX.js";import{p as I,r as B}from"./topBar-DJwU6RwO.js";const i="https://www.relda.com.br",$=JSON.parse(localStorage.getItem("userData"));document.addEventListener("DOMContentLoaded",()=>{I("cadastros"),B("cadastros",$.permissions_list),y()});const c=(s,t="success")=>{const e=document.getElementById("toast"),a=document.getElementById("toast-message"),o=e.querySelector("i");a.textContent=s,e.className="fixed bottom-4 right-4 toast flex items-center text-white px-4 py-2 rounded-lg shadow-lg",t==="error"?(e.classList.add("bg-red-500"),o.className="fas fa-times-circle mr-2"):(e.classList.add("bg-green-500"),o.className="fas fa-check-circle mr-2"),e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},3e3)},L=s=>{const t=document.querySelector("tbody"),e=document.querySelector(".md\\:hidden.divide-y");if(t.innerHTML="",e&&(e.innerHTML=""),!s||s.length===0){t.innerHTML='<tr><td colspan="6" class="text-center py-4 text-gray-500">Nenhum usuário encontrado.</td></tr>',e&&(e.innerHTML='<p class="p-4 text-center text-gray-500">Nenhum usuário encontrado.</p>');return}s.forEach(a=>{const o=(a.permissions_list||[]).map(l=>`<span class="permission-badge">${l}</span>`).join(""),d=`${a.first_name||""} ${a.last_name||""}`.trim(),r=`${(a.first_name||" ")[0]}${(a.last_name||" ")[0]}`.trim().toUpperCase(),n=a.is_active?"bg-green-100 text-green-800":"bg-red-100 text-red-800",m=a.is_active?"Ativo":"Inativo",u=`
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="avatar w-10 h-10 bg-blue-500 mr-3"><span>${r}</span></div>
                                <div><div class="text-sm font-medium text-gray-900">${d}</div></div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${a.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${a.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs rounded-full ${n}">${m}</span></td>
                        <td class="px-6 py-4"><div class="flex flex-wrap max-w-xs">${o}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-blue-500 hover:text-blue-700 mr-3 edit-user" data-id="${a.id}"><i class="fas fa-edit"></i></button>
                            <button class="text-red-500 hover:text-red-700 delete-user" data-id="${a.id}"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>`;if(t.innerHTML+=u,e){const l=`
                        <div class="p-4">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center">
                                    <div class="avatar w-10 h-10 bg-blue-500 mr-3"><span>${r}</span></div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">${d}</p>
                                        <p class="text-xs text-gray-500">${a.email}</p>
                                    </div>
                                </div>
                                <span class="px-2 py-1 text-xs rounded-full ${n}">${m}</span>
                            </div>
                            <div class="mt-3">
                                <p class="text-xs text-gray-500"><i class="fas fa-briefcase mr-1"></i> ${a.role||"N/A"}</p>
                            </div>
                            <div class="mt-3 flex flex-wrap">${o}</div>
                            <div class="mt-3 flex justify-end space-x-3">
                                <button class="text-blue-500 hover:text-blue-700 edit-user" data-id="${a.id}"><i class="fas fa-edit"></i> Editar</button>
                                <button class="text-red-500 hover:text-red-700 delete-user" data-id="${a.id}"><i class="fas fa-trash-alt"></i> Excluir</button>
                            </div>
                        </div>`;e.innerHTML+=l}})},y=async()=>{try{const s=await fetch(`${i}/api/accounts/users/`,{method:"GET",credentials:"include"});if(s.status===401){window.location.href="../login.html";return}if(!s.ok)throw new Error("Falha ao buscar usuários.");const t=await s.json();t&&L(t.results||t)}catch(s){console.error("Erro ao buscar usuários:",s),c(s.message,"error")}},v=async(s=[])=>{const t=document.querySelector(".grid.grid-cols-1.sm\\:grid-cols-2");t.innerHTML="Carregando grupos...";try{const e=await fetch(`${i}/api/groups/`,{credentials:"include"});if(!e.ok)throw new Error("Falha ao carregar grupos.");const a=await e.json();t.innerHTML="",a.forEach(o=>{const d=s.some(n=>n.id===o.id),r=document.createElement("div");r.className="flex items-center",r.innerHTML=`
                <input type="checkbox" id="group-${o.id}" data-group-id="${o.id}" 
                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                       ${d?"checked":""}>
                <label for="group-${o.id}" class="ml-2 block text-sm text-gray-700">${o.name}</label>
            `,t.appendChild(r)})}catch(e){console.error(e),t.innerHTML='<p class="text-red-500 text-xs">Não foi possível carregar as permissões.</p>'}},E=document.getElementById("user-modal"),w=document.getElementById("delete-modal"),b=document.getElementById("user-form"),p=async(s=null)=>{if(b.reset(),document.getElementById("user-id").value="",document.getElementById("email").disabled=!1,document.getElementById("password").required=!0,s){document.getElementById("modal-title").textContent="Editar Usuário",document.getElementById("password").required=!1;try{const t=await fetch(`${i}/api/accounts/users/${s}/`,{method:"GET",credentials:"include"});if(t.status===401){window.location.href="../login.html";return}if(!t.ok)throw new Error("Falha ao carregar dados do usuário.");const e=await t.json();if(await v(e.groups),!e)return;document.getElementById("user-id").value=e.id;const a=`${e.first_name||""} ${e.last_name||""}`.trim();document.getElementById("full-name").value=a,document.getElementById("email").value=e.email,document.getElementById("email").disabled=!0,document.getElementById("role").value=e.role,document.getElementById("status").checked=e.is_active,document.getElementById("status-label").textContent=e.is_active?"Ativo":"Inativo",document.querySelectorAll('input[id^="permission-"]').forEach(o=>o.checked=!1),(e.permissions_list||[]).forEach(o=>{const d=o.toLowerCase().replace(/ /g,"-").replace(/ç/g,"c").replace(/ã/g,"a"),r=document.getElementById(`permission-${d}`);r&&(r.checked=!0)}),h()}catch(t){console.error("Erro ao carregar dados do usuário",t)}}else document.getElementById("modal-title").textContent="Adicionar Novo Usuário",h(),await v();E.classList.remove("modal-hidden")},g=()=>E.classList.add("modal-hidden"),x=s=>{document.getElementById("confirm-delete").dataset.id=s,w.classList.remove("modal-hidden")},f=()=>w.classList.add("modal-hidden");document.addEventListener("DOMContentLoaded",()=>{document.getElementById("add-user-button").addEventListener("click",()=>p()),document.getElementById("close-modal").addEventListener("click",g),document.getElementById("cancel-button").addEventListener("click",g),document.querySelector("tbody").addEventListener("click",s=>{const t=s.target.closest(".edit-user"),e=s.target.closest(".delete-user");t&&p(t.dataset.id),e&&x(e.dataset.id)}),document.addEventListener("click",s=>{const t=s.target.closest(".edit-user"),e=s.target.closest(".delete-user");t&&p(t.dataset.id),e&&x(e.dataset.id)}),document.getElementById("close-delete-modal").addEventListener("click",f),document.getElementById("cancel-delete").addEventListener("click",f),document.getElementById("confirm-delete").addEventListener("click",async function(){const s=this.dataset.id;try{if((await fetch(`${i}/api/accounts/users/${s}/`,{method:"DELETE",credentials:"include"})).status!==204)throw new Error("Falha ao excluir usuário.");c("Usuário excluído com sucesso!"),f(),y()}catch(t){console.error("Erro ao excluir usuário:",t),c(t.message,"error")}}),b.addEventListener("submit",async s=>{s.preventDefault();const t=document.getElementById("user-id").value;let e="",a="",o={};const d=Array.from(document.querySelectorAll('input[id^="group-"]:checked')).map(n=>parseInt(n.dataset.groupId)),r=document.getElementById("full-name").value.split(" ");if(t){e="PATCH",a=`${i}/api/accounts/users/${t}/`,o={first_name:r.slice(0,1).join(" ")||"",last_name:r.slice(1).join(" ").trim(),is_active:document.getElementById("status").checked,groups:d};const n=document.getElementById("password").value;if(n){if(n.length<8){c("A nova senha deve ter pelo menos 8 caracteres.","error");return}o.password=n}}else if(e="POST",a=`${i}/api/accounts/users/`,o={first_name:r.slice(0,1).join(" ")||"",last_name:r.slice(1).join(" ").trim(),email:document.getElementById("email").value,password:document.getElementById("password").value,is_active:document.getElementById("status").checked,groups:d},!o.password||o.password.length<8){c("A senha é obrigatória e deve ter pelo menos 8 caracteres.","error");return}try{const n=await fetch(a,{method:e,headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(o)});if(!n.ok){const u=await n.json(),l=Object.values(u).flat().join(` 
`);throw new Error(l||"Ocorreu um erro desconhecido.")}c(t?"Usuário atualizado com sucesso!":"Usuário criado com sucesso!"),g(),y()}catch(n){console.error("Erro ao salvar usuário:",n),c(n.message,"error")}}),document.getElementById("toggle-password").addEventListener("click",function(){const s=document.getElementById("password"),t=this.querySelector("i"),e=s.type==="password";s.type=e?"text":"password",t.className=e?"fas fa-eye-slash":"fas fa-eye"}),document.getElementById("status").addEventListener("change",function(){document.getElementById("status-label").textContent=this.checked?"Ativo":"Inativo"}),document.querySelectorAll('input[id^="permission-"]').forEach(s=>{s.addEventListener("change",h)})});function h(){const s=document.getElementById("permissions-summary"),t=document.querySelectorAll('input[id^="permission-"]:checked');s.innerHTML=t.length===0?'<span class="text-xs text-gray-500">Nenhuma permissão selecionada</span>':"",t.forEach(e=>{const a=document.querySelector(`label[for="${e.id}"]`).textContent,o=document.createElement("span");o.className="permission-badge",o.textContent=a,s.appendChild(o)})}
