import"./modulepreload-polyfill-B5Qt9EMX.js";import{p as I,r as $}from"./topBar-DJwU6RwO.js";const l="https://www.relda.com.br",M=JSON.parse(localStorage.getItem("userData"));document.addEventListener("DOMContentLoaded",()=>{I("pagamentos"),$("movimentacoes",M.permissions_list),F(),u()});let y=null,c=new Date;const L=document.getElementById("prev-month-btn"),C=document.getElementById("next-month-btn"),D=document.getElementById("current-month-display");function T(){const t=c.toLocaleString("pt-BR",{month:"long"}),n=c.getFullYear();D.textContent=`${t.charAt(0).toUpperCase()+t.slice(1)} / ${n}`}L.addEventListener("click",()=>{c.setMonth(c.getMonth()-1),u()});C.addEventListener("click",()=>{c.setMonth(c.getMonth()+1),u()});function k(t){const a=document.querySelector(`button[onclick="markAsPaid(${t})"]`).closest("tr").cells[3].textContent.replace("R$","").replace(/\./g,"").replace(",",".").trim();_(t,a)}async function _(t,n){const e=document.getElementById("mark-as-paid-modal"),a=document.getElementById("payment-account");try{const r=await(await fetch(`${l}/api/finance/bank-accounts/?is_active=true`,{credentials:"include"})).json();a.innerHTML='<option value="">Selecione a conta de origem</option>',r.forEach(o=>{a.innerHTML+=`<option value="${o.id}">${o.name} (${m(o.initial_balance)})</option>`})}catch(s){console.error(s)}document.getElementById("payable-id-input").value=t,document.getElementById("payment-amount").value=parseFloat(n).toFixed(2),document.getElementById("payment-date").valueAsDate=new Date,e.classList.remove("hidden")}function S(){document.getElementById("add-bill-button").addEventListener("click",A),document.getElementById("cancel-modal").addEventListener("click",E),document.getElementById("bill-form").addEventListener("submit",N),document.getElementById("confirm-delete-btn").addEventListener("click",J),document.getElementById("cancel-delete-btn").addEventListener("click",x),document.getElementById("add-card-expense-btn").addEventListener("click",w)}async function P(){try{const n=await(await fetch("/modalGastoCartao.html")).text();document.getElementById("card-expense-modal-container").innerHTML=n,document.getElementById("add-card-expense-btn").addEventListener("click",w),document.getElementById("cancelCardExpenseBtn").addEventListener("click",b),document.getElementById("cardExpenseForm").addEventListener("submit",U)}catch(t){console.error("Falha ao carregar componentes:",t)}}function F(){S(),P()}const m=t=>parseFloat(t).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),f=t=>{const[n,e,a]=t.split("-");return`${a}/${e}/${n}`};function d(t,n="success"){const e=document.getElementById("toast-notification"),a=document.getElementById("toast-message");if(!e||!a){console.error("Elementos do Toast não encontrados no DOM.");return}a.textContent=t;const s=n==="success"?"bg-green-500":"bg-red-500";e.className=`fixed bottom-4 right-4 text-white px-4 py-2 rounded-lg shadow-lg toast ${s}`,setTimeout(()=>{e.className="hidden"},3e3)}function H(t){const n=document.getElementById("payables-table-body");if(n.innerHTML="",t.length===0){n.innerHTML='<tr><td colspan="6" class="text-center py-4 text-gray-500">Nenhuma conta para este mês.</td></tr>';return}t.forEach(e=>{const a=document.createElement("tr");let s="",r="";switch(e.status){case"pago":s="bg-green-100 text-green-800",r="Pago",a.classList.add("bg-green-50");break;case"vencido":s="bg-red-100 text-red-800",r="Vencido",a.classList.add("bg-red-50");break;default:s="bg-yellow-100 text-yellow-800",r="Pendente";break}if(e.type==="card"){const o=new Date(c.getFullYear(),c.getMonth(),e.due_day);a.innerHTML=`
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            <i class="fas fa-credit-card text-indigo-500 mr-2"></i>
                            Fatura ${e.card_name}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Fatura de Cartão</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">${f(o.toISOString().split("T")[0])}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-indigo-600">${m(e.total_amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                             <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${s}">${r}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewCardStatement(${e.card_id})" class="text-indigo-600 hover:text-indigo-900 transition-colors" title="Ver Detalhes da Fatura">
                                <i class="fas fa-eye"></i> Ver Detalhes
                            </button>
                        </td>
                    `}else a.innerHTML=`
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${e.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.category_name||"N/A"}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${e.status==="vencido"?"text-red-600 font-bold":"text-gray-500"}">${f(e.due_date)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">${m(e.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${s}">${r}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            ${e.status!=="pago"?`<button onclick="markAsPaid(${e.id})" class="text-green-600 hover:text-green-800 mr-3" title="Marcar como Pago"><i class="fas fa-check-circle"></i></button>`:""}
                            <button onclick="openEditModal(${e.id})" class="text-blue-600 hover:text-blue-800 mr-3" title="Editar"><i class="fas fa-edit"></i></button>
                            <button onclick="openDeleteModal(${e.id})" class="text-red-500 hover:text-red-700" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;n.appendChild(a)})}function O(t){const n=c.getFullYear(),e=c.getMonth()+1;window.location.href=`detalheFatura.html?card_id=${t}&month=${e}&year=${n}`}async function u(){T();const t=c.getFullYear(),n=c.getMonth()+1,e=`${l}/api/finance/monthly-bills/?month=${n}&year=${t}`;try{const a=await fetch(e,{credentials:"include"});if(a.status===401){window.location.href="login.html";return}if(!a.ok)throw new Error("Falha ao buscar as contas do mês.");const s=await a.json(),r=s.manual_bills.map(i=>({...i,type:"manual"})),o=s.card_bills.map(i=>({...i,type:"card"}));let p=[...r,...o];p.sort((i,g)=>{const v=i.type==="card"?new Date(t,n-1,i.due_day):new Date(i.due_date),B=g.type==="card"?new Date(t,n-1,g.due_day):new Date(g.due_date);return v-B}),H(p),j(p)}catch(a){d(a.message,"error")}}function j(t){let n=0,e=0,a=0;new Date().setHours(0,0,0,0),t.forEach(r=>{const o=parseFloat(r.amount||r.total_amount);r.status==="pago"?e+=o:(n+=o,r.status==="vencido"&&(a+=o))}),document.getElementById("summary-total-open").textContent=m(n),document.getElementById("summary-total-paid").textContent=m(e),document.getElementById("summary-total-overdue").textContent=m(a)}async function h(){const t=document.getElementById("bill-category");try{const n=await fetch(`${l}/api/finance/categories/?type=saida`);if(!n.ok)throw new Error("Falha ao carregar categorias.");const e=await n.json();t.innerHTML='<option value="">Selecione uma Categoria</option>',e.forEach(a=>{t.innerHTML+=`<option value="${a.id}">${a.name}</option>`})}catch(n){t.innerHTML='<option value="">Erro ao carregar</option>',d(n.message,"error")}}async function A(){document.getElementById("bill-form").reset(),document.getElementById("modal-title").textContent="Nova Conta a Pagar",document.getElementById("bill-id").value="",await h(),document.getElementById("bill-modal").classList.remove("hidden")}function E(){document.getElementById("bill-modal").classList.add("hidden")}async function N(t){t.preventDefault();const n=document.getElementById("bill-id").value,e={description:document.getElementById("bill-description").value,amount:document.getElementById("bill-amount").value,due_date:document.getElementById("bill-due-date").value,category:document.getElementById("bill-category").value||null,status:document.getElementById("bill-status").value||"pendente"};if(!e.description||!e.amount||!e.due_date){d("Descrição, Valor e Data de Vencimento são obrigatórios.","error");return}const a=n?`${l}/api/finance/payables/${n}/`:`${l}/api/finance/payables/`,s=n?"PUT":"POST",r=document.getElementById("save-bill");r.disabled=!0,r.textContent="Salvando...";try{const o=await fetch(a,{method:s,headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)});if(!o.ok){const p=await o.json();throw new Error(`Erro ao salvar: ${JSON.stringify(p)}`)}d(n?"Conta atualizada com sucesso!":"Conta criada com sucesso!"),E(),u()}catch(o){d(o.message,"error")}finally{r.disabled=!1,r.textContent="Salvar"}}async function R(t){document.getElementById("bill-id").value=t,await h();try{const n=await fetch(`${l}/api/finance/payables/${t}/`,{credentials:"include"});if(n.status===401){window.location.href="login.html";return}if(!n.ok)throw new Error("Falha ao buscar dados da conta.");const e=await n.json();document.getElementById("modal-title").textContent="Editar Conta a Pagar",document.getElementById("bill-description").value=e.description,document.getElementById("bill-amount").value=e.amount,document.getElementById("bill-due-date").value=e.due_date,document.getElementById("bill-category").value=e.category||"",document.getElementById("bill-status").value=e.status,document.getElementById("bill-modal").classList.remove("hidden")}catch(n){d(n.message,"error")}}function V(t){y=t,document.getElementById("delete-modal").classList.remove("hidden")}function x(){y=null,document.getElementById("delete-modal").classList.add("hidden")}async function J(){if(y)try{if((await fetch(`${l}/api/finance/payables/${y}/`,{method:"DELETE",credentials:"include"})).status!==204)throw new Error("Erro ao excluir a conta.");d("Conta excluída com sucesso!"),x(),u()}catch(t){d(t.message,"error")}}async function w(){const t=document.getElementById("card-expense-card"),n=document.getElementById("card-expense-category");try{const[e,a]=await Promise.all([fetch(`${l}/api/finance/credit-cards/?is_active=true`,{credentials:"include"}),fetch(`${l}/api/finance/categories/?type=saida`,{credentials:"include"})]),s=await e.json(),r=await a.json();t.innerHTML='<option value="">Selecione um cartão</option>',s.forEach(o=>{t.innerHTML+=`<option value="${o.id}">${o.name} (final ${o.last_digits})</option>`}),n.innerHTML='<option value="">Selecione uma categoria</option>',r.forEach(o=>{n.innerHTML+=`<option value="${o.id}">${o.name}</option>`}),document.getElementById("cardExpenseModal").classList.remove("hidden")}catch(e){console.error(e),d("Erro ao carregar dados para o formulário.","error")}}function b(){document.getElementById("cardExpenseModal").classList.add("hidden")}async function U(t){t.preventDefault();const n=document.getElementById("saveCardExpenseBtn"),e={description:document.getElementById("card-expense-description").value,amount:document.getElementById("card-expense-amount").value,installments:document.getElementById("card-expense-installments").value,credit_card_id:document.getElementById("card-expense-card").value,category_id:document.getElementById("card-expense-category").value,transaction_date:document.getElementById("card-expense-date").value};if(!e.description||!e.amount||!e.credit_card_id||!e.category_id||!e.transaction_date){d("Por favor, preencha todos os campos obrigatórios.","error");return}n.disabled=!0,n.textContent="Criando...";try{const a=await fetch(`${l}/api/finance/card-expense/`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)}),s=await a.json();if(!a.ok)throw new Error(s.error||"Ocorreu um erro ao registrar a despesa.");d(s.success||"Despesa registrada com sucesso!"),document.getElementById("cardExpenseForm").reset(),b(),u()}catch(a){d(a.message,"error")}finally{n.disabled=!1,n.textContent="Criar Parcelas"}}window.markAsPaid=k;window.openEditModal=R;window.openDeleteModal=V;window.viewCardStatement=O;
