import"./modulepreload-polyfill-B5Qt9EMX.js";import{p as b,r as w}from"./topBar-Ccw8a5qR.js";const c="https://www.relda.com.br",B=JSON.parse(localStorage.getItem("userData"));document.addEventListener("DOMContentLoaded",()=>{b("pagamentos"),w("pagamentos",B.permissions_list),_(),S(),d()});const v=document.getElementById("receivable-modal"),m=document.getElementById("receivable-form"),y=document.getElementById("receivables-table-body"),E=document.getElementById("receivables-mobile-list"),I=t=>new Date(t).toLocaleDateString("pt-BR",{timeZone:"UTC"}),u=t=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t),x=(t,e)=>{const n=new Date;n.setHours(0,0,0,0);const a=new Date(e);return t==="received"?'<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>Recebido</span>':a<n?'<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800"><i class="fas fa-exclamation-circle mr-1"></i>Vencido</span>':'<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800"><i class="fas fa-clock mr-1"></i>Pendente</span>'};let f=null;const L=async t=>{try{const e=await fetch(`${c}/api/finance/receivables-summary/?${t.toString()}`,{method:"GET",credentials:"include"});if(e.status===401){window.location.href="login.html";return}const n=await e.json();n&&(k(n),T(n.chart_data))}catch(e){console.error("Erro ao buscar dados de resumo:",e)}},k=t=>{document.getElementById("total-to-receive").textContent=u(t.total_to_receive),document.getElementById("total-received").textContent=u(t.total_received)},T=t=>{const e=document.getElementById("statusChart").getContext("2d");f&&f.destroy(),f=new Chart(e,{type:"doughnut",data:{labels:t.labels,datasets:[{label:"Total por Status",data:t.data,backgroundColor:["#F59E0B","#10B981","#EF4444"],borderColor:"#fff",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},tooltip:{callbacks:{label:function(n){let a=n.label||"";return a&&(a+=": "),n.parsed!==null&&(a+=u(n.parsed)),a}}}}}})},$=t=>{if(y.innerHTML="",E.innerHTML="",t.length===0){const e='<td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">Nenhuma conta a receber encontrada.</td>';y.innerHTML=`<tr>${e}</tr>`,E.innerHTML=`<div class="p-4">${e}</div>`;return}t.forEach(e=>{const n=`
                    <button class="edit-btn text-blue-500 hover:text-blue-700 mr-3" data-id="${e.id}">Editar</button>
                    ${e.status==="pending"?`<button class="mark-received-btn text-green-500 hover:text-green-700 mr-3" data-id="${e.id}">Receber</button>`:""}
                    <button class="delete-btn text-red-500 hover:text-red-700" data-id="${e.id}">Excluir</button>
                `,a=document.createElement("tr");a.innerHTML=`
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${e.customer_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${u(e.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${I(e.due_date)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${x(e.status,e.due_date)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">${n}</td>
                `,y.appendChild(a)})},C=t=>{const e=document.getElementById("client-filter"),n=document.getElementById("customer_id");e.innerHTML='<option value="">Todos</option>',n.innerHTML="",n.innerHTML+='<option value="" disabled selected>Selecione um cliente</option>',n.innerHTML+='<option value="null" class="font-bold">Não Definir</option>',t.forEach(a=>{const r=`<option value="${a.id}">${a.name}</option>`;e.innerHTML+=r,n.innerHTML+=r}),n.innerHTML+='<option value="new_customer" class="text-blue-500 font-bold">-- Novo Cliente --</option>'},p=(t,e="success")=>{},_=async()=>{try{const t=await fetch(`${c}/api/cadastros/customers/`,{method:"GET",credentials:"include"});if(t.status===401){window.location.href="login.html";return}const e=await t.json();e&&C(e)}catch(t){console.error("Erro ao buscar clientes:",t)}},S=async()=>{try{const t=await fetch(`${c}/api/finance/bank-accounts/`,{method:"GET",credentials:"include"});if(t.status===401){window.location.href="login.html";return}const e=await t.json();e&&M(e.results||e)}catch(t){console.error("Erro ao buscar contas bancárias:",t)}},M=t=>{const e=document.getElementById("bank_account_id");e&&(e.innerHTML='<option value="" disabled selected>Selecione uma conta</option>',t.forEach(n=>{const a=document.createElement("option");a.value=n.id,a.textContent=n.name,e.appendChild(a)}))},d=async()=>{const t=new URLSearchParams,e=document.getElementById("period-filter").value;e&&t.append("period-filter",e);const n=document.getElementById("status-filter").value;n&&t.append("status",n);const a=document.getElementById("client-filter").value;a&&t.append("client_id",a);const r=document.getElementById("search-input").value;r&&t.append("search",r),L(t);try{const s=await fetch(`${c}/api/finance/receivables/?${t.toString()}`,{method:"GET",credentials:"include"});if(s.status===401){window.location.href="login.html";return}const o=await s.json();o&&$(o.results||o)}catch(s){console.error("Erro ao buscar contas a receber:",s)}},D=async t=>{if(t.preventDefault(),!m.checkValidity()){m.reportValidity();return}const e=new FormData(m),n=e.get("id"),a=Object.fromEntries(e.entries());a.customer_id==="null"&&(a.customer_id=null);const r=n?"PATCH":"POST",s=n?`${c}/api/finance/receivables/${n}/`:`${c}/api/finance/receivables/`;try{const o=await fetch(s,{method:r,headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(a)});if(!o.ok){const i=await o.json();throw new Error(i.detail||"Falha ao salvar a conta.")}p(`Conta ${n?"atualizada":"criada"} com sucesso!`),h(),d()}catch(o){console.error("Erro ao salvar conta:",o),p(o.message,"error")}},H=async t=>{try{const e=await fetch(`${c}/api/finance/receivables/${t}/`,{method:"GET",credentials:"include"});if(e.status===401){window.location.href="login.html";return}const n=await e.json();n&&(document.getElementById("modal-title").textContent="Editar Conta a Receber",document.getElementById("receivable-id").value=n.id,document.getElementById("customer_id").value=n.customer.id,document.getElementById("description").value=n.description,document.getElementById("amount").value=n.amount,document.getElementById("due_date").value=n.due_date,document.getElementById("payment_method").value=n.payment_method,document.getElementById("notes").value=n.notes||"",v.classList.remove("hidden"))}catch(e){console.error("Erro ao buscar dados para edição:",e)}},R=async t=>{if(confirm("Tem certeza que deseja excluir esta conta?"))try{if((await fetch(`${c}/api/finance/receivables/${t}/`,{method:"DELETE",credentials:"include"})).status!==204)throw new Error("Falha ao excluir.");p("Conta excluída com sucesso!"),d()}catch(e){console.error("Erro ao excluir conta:",e)}},j=async t=>{try{const e=await fetch(`${c}/api/finance/receivables/${t}/`,{method:"GET",credentials:"include"});if(e.status===401){window.location.href="login.html";return}const n=await e.json();if(n){const a=document.getElementById("mark-as-received-form");a.querySelector("#mark-as-received-receivable-id").value=n.id,a.querySelector("#received_amount").value=n.amount,a.querySelector("#payment_date").value=new Date().toISOString().split("T")[0],document.getElementById("mark-as-received-modal").classList.remove("hidden")}}catch(e){console.error("Erro ao preparar modal de recebimento:",e)}},A=()=>{document.getElementById("modal-title").textContent="Adicionar Conta a Receber",m.reset(),document.getElementById("receivable-id").value="",v.classList.remove("hidden")},h=()=>v.classList.add("hidden");document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("period-filter"),n=new Date().toISOString().slice(0,7);t.value=n,document.getElementById("add-receivable-btn").addEventListener("click",A),document.getElementById("close-modal").addEventListener("click",h),document.getElementById("cancel-modal").addEventListener("click",h),m.addEventListener("submit",D),document.getElementById("status-filter").addEventListener("change",d),document.getElementById("client-filter").addEventListener("change",d),document.getElementById("period-filter").addEventListener("change",d),document.getElementById("search-input").addEventListener("input",d),document.getElementById("reset-filters").addEventListener("click",()=>{document.getElementById("period-filter").value="",document.getElementById("status-filter").value="",document.getElementById("client-filter").value="",document.getElementById("search-input").value="",d()}),document.getElementById("receivables-table-body").addEventListener("click",o=>{const i=o.target,l=i.getAttribute("data-id");l&&(i.classList.contains("edit-btn")&&H(l),i.classList.contains("delete-btn")&&R(l),i.classList.contains("mark-received-btn")&&j(l))}),document.getElementById("customer_id").addEventListener("change",o=>{o.target.value==="new_customer"&&(window.location.href="clientes.html")});const a=document.getElementById("mark-as-received-modal"),r=document.getElementById("mark-as-received-form"),s=()=>a.classList.add("hidden");document.getElementById("close-mark-as-received-modal").addEventListener("click",s),document.getElementById("cancel-mark-as-received-modal").addEventListener("click",s),r.addEventListener("submit",async o=>{if(o.preventDefault(),!r.checkValidity()){r.reportValidity();return}const i=document.getElementById("mark-as-received-receivable-id").value,l={bank_account_id:document.getElementById("bank_account_id").value,payment_date:document.getElementById("payment_date").value};try{if(!(await fetch(`${c}/api/finance/receivables/${i}/mark-as-received/`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(l)})).ok)throw new Error("Falha ao marcar como recebido.");p("Conta marcada como recebida!"),document.getElementById("mark-as-received-modal").classList.add("hidden"),d()}catch(g){console.error("Erro ao marcar como recebido:",g)}})});
