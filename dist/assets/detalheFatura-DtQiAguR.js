import"./modulepreload-polyfill-B5Qt9EMX.js";const s="https://www.relda.com.br";function d(){const t=new URLSearchParams(window.location.search);return{card_id:t.get("card_id"),month:t.get("month"),year:t.get("year")}}const c=t=>parseFloat(t).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),l=t=>{if(!t)return"--/--/----";if(t.includes("/"))return t;const[a,n,e]=t.split("-");return`${e}/${n}/${a}`};async function i(){const t=d();if(!t.card_id||!t.month||!t.year){document.getElementById("card-name").textContent="Parâmetros inválidos na URL.";return}const a=`${s}/api/finance/card-bill-detail/?card_id=${t.card_id}&month=${t.month}&year=${t.year}`;try{const n=await fetch(a,{credentials:"include"});if(n.status===401){window.location.href="../login.html";return}if(!n.ok)throw new Error("Falha ao buscar os detalhes da fatura.");const e=await n.json();p(e)}catch(n){console.error("Erro:",n),document.getElementById("card-name").textContent="Erro ao carregar os dados."}}function p(t){document.getElementById("card-name").textContent=t.card_name,document.getElementById("bill-period").textContent=t.bill_period,document.getElementById("bill-total").textContent=c(t.total_amount),document.getElementById("bill-paid").textContent=c(t.paid_amount),document.getElementById("bill-due-date").textContent=l(t.due_date);const a=document.getElementById("bill-status"),n=document.getElementById("mark-as-paid-btn"),e=t.total_amount-t.paid_amount;e<=0?(a.innerHTML='<span class="px-2 py-1 rounded-full bg-green-100 text-green-800">Fatura Paga</span>',n.classList.add("hidden")):(a.innerHTML=`<span class="px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">Pendente (${c(e)} em aberto)</span>`,n.classList.remove("hidden"));const r=document.getElementById("transactions-list");r.innerHTML="",t.transactions&&t.transactions.length>0?t.transactions.forEach(o=>{r.innerHTML+=`
                        <tr class="${o.status==="pago"?"bg-green-50":""}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${l(o.transaction_date)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${o.description}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${o.category_name||"N/A"}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-semibold">${c(o.amount)}</td>
                        </tr>
                    `}):r.innerHTML='<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhuma transação para esta fatura.</td></tr>'}const m=document.getElementById("mark-as-paid-modal");async function y(){const t=document.getElementById("payment-account"),a=parseFloat(document.getElementById("bill-total").textContent.replace("R$","").replace(".","").replace(",",".")),n=parseFloat(document.getElementById("bill-paid").textContent.replace("R$","").replace(".","").replace(",","."));document.getElementById("payment-amount").value=(a-n).toFixed(2),document.getElementById("payment-date").valueAsDate=new Date,t.innerHTML='<option value="">Carregando...</option>';try{const e=await fetch(`${s}/api/finance/bank-accounts/?is_active=true`,{credentials:"include"});if(e.status===401){window.location.href="../login.html";return}const r=await e.json();t.innerHTML='<option value="">Selecione a conta</option>',r.forEach(o=>{t.innerHTML+=`<option value="${o.id}">${o.name} (${c(o.initial_balance)})</option>`})}catch(e){console.error("Erro ao buscar contas:",e),t.innerHTML='<option value="">Erro ao carregar contas</option>'}m.classList.remove("hidden")}function u(){m.classList.add("hidden")}async function g(t){t.preventDefault();const a=d(),n={card_id:a.card_id,month:a.month,year:a.year,bank_account_id:document.getElementById("payment-account").value,amount:document.getElementById("payment-amount").value,payment_date:document.getElementById("payment-date").value};if(!n.bank_account_id){alert("Por favor, selecione a conta de origem.");return}try{const e=await fetch(`${s}/api/finance/pay-card-bill/`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)}),r=await e.json();if(!e.ok)throw new Error(r.error||"Erro ao processar pagamento.");alert("Fatura paga com sucesso!"),u(),i()}catch(e){alert(`Erro: ${e.message}`)}}document.addEventListener("DOMContentLoaded",()=>{i(),document.getElementById("mark-as-paid-btn").addEventListener("click",y),document.getElementById("cancel-payment-btn").addEventListener("click",u),document.getElementById("payment-form").addEventListener("submit",g)});
