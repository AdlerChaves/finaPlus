import"./modulepreload-polyfill-B5Qt9EMX.js";const y="https://www.relda.com.br";async function w(){try{const e=await fetch(`${y}/api/accounts/me/`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});if(e.ok){const t=await e.json();return localStorage.setItem("userData",JSON.stringify(t)),t}else return localStorage.removeItem("userData"),null}catch(e){return console.error("Erro ao buscar dados do usuário:",e),localStorage.removeItem("userData"),null}}async function v(e){let t=JSON.parse(localStorage.getItem("userData"));if(t||(t=await w()),!t){window.location.href="/src/pages/login/login.html";return}if(!t.permissions_list||!t.permissions_list.includes(e)){console.warn(`Acesso negado. Permissão necessária: ${e}`),window.location.href="/index.html";return}const o=document.getElementById("user-name");o&&(o.textContent=`${t.first_name} ${t.last_name}`)}async function $(e,t){try{const n=await fetch("/componentes/topBar/topBar.html");if(!n.ok)throw new Error(`Não foi possível carregar o topBar.html: ${n.statusText}`);const s=await n.text();document.body.insertAdjacentHTML("afterbegin",s),C(e,t),document.getElementById("mobile-menu-button").addEventListener("click",()=>{document.getElementById("mobile-menu").classList.toggle("hidden")})}catch(o){console.error("Erro ao renderizar o topbar:",o)}}function C(e,t){const o=document.getElementById("desktop-menu"),n=document.getElementById("mobile-menu");if(!o||!n)return;const s=window.location.pathname.endsWith("/")||window.location.pathname.endsWith("index.html"),i=s?"telas/":"../telas/",x=[{name:"Movimentações",permission:"movimentacoes",icon:'<svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>',submenus:[{name:"Entradas",href:`${i}entradas.html`},{name:"Saídas",href:`${i}saidas.html`}]}];let c="",d="";const f="active font-semibold text-blue-600";c+=`<a href="${s?"index.html":"../../index.html"}" class="menu-item ${f} hover:text-blue-500 transition-colors flex items-center">Dashboard</a>`,d+=`<a href="${s?"index.html":"../../index.html"}" class="block py-2 ${f} hover:text-blue-500">Dashboard</a>`,x.forEach(a=>{if(t[a.permission]){const m=e===a.permission?"active font-semibold text-blue-600":"text-gray-700";a.isSingleLink?(c+=`<a href="${a.href}" class="menu-item ${m} hover:text-blue-500 transition-colors flex items-center self-center">${a.icon} ${a.name}</a>`,d+=`<a href="${a.href}" class="block py-2 ${m} hover:text-blue-500">${a.name}</a>`):(c+=`
                    <div class="relative group py-2">
                        <button class="px-3 py-2 ${m} hover:text-blue-500 transition-colors flex items-center">
                            ${a.icon} ${a.name}
                        </button>
                        <div class="absolute left-0 mt-2 w-56 bg-white rounded-md shadow-lg py-1 z-30 hidden group-hover:block">
                            ${a.submenus.map(l=>`<a href="${l.href}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600">${l.name}</a>`).join("")}
                        </div>
                    </div>`,d+=`
                    <div class="py-2">
                        <p class="font-semibold text-gray-500 text-sm px-4">${a.name}</p>
                        ${a.submenus.map(l=>`<a href="${l.href}" class="block pl-8 pr-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600">${l.name}</a>`).join("")}
                    </div>`)}}),o.innerHTML=c,n.innerHTML=d}const h="https://www.relda.com.br";let u=null,p=null;document.addEventListener("DOMContentLoaded",async function(){try{await v("dashboard");const e=JSON.parse(localStorage.getItem("userData"));e&&e.permissions_list?await $("dashboard",e.permissions_list):console.error("Não foi possível encontrar as permissões do usuário."),b(),_(),E(),B()}catch(e){console.error("Ocorreu um erro durante a inicialização da página:",e)}});function b(){const e=localStorage.getItem("userName");if(e){const t=document.getElementById("user-name-display");t&&(t.textContent=e)}}async function E(){try{const e=await fetch(`${h}/finance/charts/income-expense/`,{credentials:"include"});if(!e.ok)throw new Error("Falha ao buscar dados do gráfico.");const t=await e.json();I(t)}catch(e){console.error("Erro ao carregar dados do gráfico:",e)}}function I(e){var o;const t=(o=document.getElementById("barChart"))==null?void 0:o.getContext("2d");t&&(u&&u.destroy(),u=new Chart(t,{type:"bar",data:{labels:e.labels,datasets:[{label:"Receitas",data:e.income_data,backgroundColor:"rgba(75, 192, 192, 0.6)",borderColor:"rgba(75, 192, 192, 1)",borderWidth:1},{label:"Despesas",data:e.expense_data,backgroundColor:"rgba(255, 99, 132, 0.6)",borderColor:"rgba(255, 99, 132, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}}))}async function B(){try{const e=await fetch(`${h}/api/finance/charts/cash-flow/`,{credentials:"include"});if(!e.ok)throw new Error("Falha ao buscar dados do fluxo de caixa.");const t=await e.json();D(t)}catch(e){console.error("Erro ao carregar dados do fluxo de caixa:",e)}}function D(e){var o;const t=(o=document.getElementById("lineChart"))==null?void 0:o.getContext("2d");t&&(p&&p.destroy(),p=new Chart(t,{type:"line",data:{labels:e.labels,datasets:[{label:"Saldo Acumulado",data:e.cumulative_balance,fill:!1,borderColor:"rgba(54, 162, 235, 1)",backgroundColor:"rgba(54, 162, 235, 0.6)",tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!1}}}}))}async function _(){console.log("Iniciando a função loadDashboardData...");try{const e=await fetch(`${h}/api/finance/dashboard/`,{credentials:"include"});if(console.log("Resposta da API recebida com status:",e.status),e.status===401){console.error("Não autorizado (401). Redirecionando para login."),window.location.href="./src/pages/login/login.html";return}if(!e.ok)throw new Error(`Falha na rede: ${e.statusText}`);const t=await e.json();console.log("Dados recebidos do backend:",t),k(t.summary_cards),L(t.alerts.upcoming_payables),T(t.recent_transactions),t.user_info&&t.user_info.name&&(localStorage.setItem("userName",t.user_info.name),b())}catch(e){console.error("Erro fatal ao buscar dados do dashboard:",e);const t=document.getElementById("upcoming-payables-container");t&&(t.innerHTML=`<div class="p-4 bg-red-50 text-red-700 rounded-lg">
                    <p class="font-bold">Erro de Conexão</p>
                    <p class="text-sm">Não foi possível carregar os dados do dashboard. Verifique sua conexão e tente recarregar a página.</p>
                </div>`)}}const r=e=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(e||0),g=e=>e?new Date(e).toLocaleDateString("pt-BR",{timeZone:"UTC"}):"Data inválida";function k(e){if(!e)return;document.getElementById("current-balance").textContent=r(e.current_balance),document.getElementById("monthly-income").textContent=r(e.monthly_income),document.getElementById("monthly-expenses").textContent=r(e.monthly_expenses);const t=document.getElementById("monthly-result");t.textContent=r(e.monthly_result),t.className=e.monthly_result>=0?"text-2xl font-bold mt-1 text-green-600":"text-2xl font-bold mt-1 text-red-600",document.getElementById("total-payables").textContent=r(e.total_payables),document.getElementById("total-receivables").textContent=r(e.total_receivables)}function L(e){const t=document.getElementById("upcoming-payables-container");if(t){if(t.innerHTML="",!e||e.length===0){t.innerHTML='<p class="text-sm text-gray-500 p-3 bg-gray-50 rounded-lg">Nenhum vencimento nos próximos 7 dias.</p>';return}e.forEach(o=>{t.innerHTML+=`
                <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                    <div>
                        <p class="text-sm font-medium">${o.description}</p>
                        <p class="text-xs text-gray-500">Vence em: ${g(o.due_date)}</p>
                    </div>
                    <p class="text-sm font-bold text-yellow-600">${r(o.amount)}</p>
                </div>`})}}function T(e){const t=document.getElementById("recent-transactions-container");if(t){if(t.innerHTML="",!e||e.length===0){t.innerHTML='<p class="text-sm text-gray-500 p-3">Nenhum lançamento recente.</p>';return}e.forEach(o=>{const n=o.type==="entrada",s=n?"text-green-600":"text-red-600",i=n?"+":"-";t.innerHTML+=`
                <div class="flex justify-between items-center pb-3 mb-3 border-b last:border-b-0">
                    <div>
                        <p class="text-sm font-medium">${o.description}</p>
                        <p class="text-xs text-gray-500">${g(o.transaction_date)}</p>
                    </div>
                    <p class="text-sm font-bold ${s}">${i} ${r(o.amount)}</p>
                </div>`})}}
