import"./modulepreload-polyfill-B5Qt9EMX.js";import{p as $,r as C}from"./topBar-Ccw8a5qR.js";const r="https://www.relda.com.br",T=JSON.parse(localStorage.getItem("userData"));document.addEventListener("DOMContentLoaded",()=>{$("movimentacoes"),m(),C("movimentacoes",T.permissions_list)});const x=document.getElementById("expenseModal"),B=document.getElementById("delete-modal"),k=document.getElementById("add-expense-header-btn"),D=document.getElementById("addExpenseBtn"),I=document.getElementById("expenseForm");document.getElementById("expensesTableBody");const f=document.getElementById("expense-category"),h=document.getElementById("expense-account"),p=document.getElementById("toast-notification"),S=document.getElementById("toast-message");document.getElementById("totalExpenses");const v=document.getElementById("total-expenses-summary");let u=null,y=null,g=null;const l=n=>parseFloat(n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),b=n=>{const[t,a,o]=n.split("-");return`${o}/${a}/${t}`};function i(n,t="success"){const a=t==="success"?"bg-green-500":"bg-red-600";p.className=`fixed bottom-5 right-5 px-5 py-3 rounded-lg shadow-lg text-white ${a}`,S.textContent=n,p.classList.remove("hidden"),setTimeout(()=>{p.classList.add("hidden")},3e3)}function w(n){const t=n.reduce((e,s)=>{const c=s.category_name||"Sem Categoria";return e[c]=(e[c]||0)+parseFloat(s.amount),e},{}),a=n.reduce((e,s)=>{const c=s.bank_account_name||"Conta Deletada";return e[c]=(e[c]||0)+parseFloat(s.amount),e},{});y&&y.destroy(),g&&g.destroy();const o=document.getElementById("expenseChart").getContext("2d");y=new Chart(o,{type:"doughnut",data:{labels:Object.keys(t),datasets:[{data:Object.values(t),backgroundColor:["#3B82F6","#EF4444","#10B981","#F59E0B","#6366F1"]}]},options:{responsive:!0,maintainAspectRatio:!1}});const d=document.getElementById("statusChart").getContext("2d");g=new Chart(d,{type:"bar",data:{labels:Object.keys(a),datasets:[{label:"Total Gasto",data:Object.values(a),backgroundColor:"#8B5CF6"}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y"}})}async function _(n){try{const[t,a]=await Promise.all([fetch(`${r}/api/finance/categories/?type=saida`,{credentials:"include"}),fetch(`${r}/api/finance/bank-accounts/`,{credentials:"include"})]);if(t.status===401||a.status===401){window.location.href="login.html";return}if(!t.ok||!a.ok)throw new Error("Falha ao carregar dados para o formulário.");const o=await t.json(),d=await a.json();f.innerHTML='<option value="">Selecione a Categoria</option>',o.forEach(e=>{f.innerHTML+=`<option value="${e.id}">${e.name}</option>`}),h.innerHTML='<option value="">Selecione a Conta</option>',d.filter(e=>e.is_active).forEach(e=>{h.innerHTML+=`<option value="${e.id}">${e.name}</option>`})}catch(t){console.error("Erro ao popular dropdowns:",t),i(t.message,"error")}}async function m(){await _();try{const n=await fetch(`${r}/api/finance/transactions/?type=saida`,{credentials:"include"});if(n.status===401){window.location.href="login.html";return}if(!n.ok)throw new Error("Falha ao buscar despesas.");const t=await n.json(),a=document.getElementById("expenses-list-mobile"),o=document.getElementById("expensesTableBody");if(o.innerHTML="",a.innerHTML="",t.length===0){const e='<tr><td colspan="6" class="text-center py-4 text-gray-500">Nenhuma despesa registrada.</td></tr>';o.innerHTML=e,a.innerHTML='<p class="text-center py-4 text-gray-500">Nenhuma despesa registrada.</p>',v.textContent=l(0),w([]);return}const d=t.reduce((e,s)=>e+parseFloat(s.amount),0);v.textContent=l(d),t.forEach(e=>{const s=document.createElement("tr");s.innerHTML=`
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${e.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">${l(e.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.category_name||"N/A"}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${b(e.transaction_date)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.bank_account_name||"N/A"}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="openEditModal(${e.id})" class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button>
                        <button onclick="openDeleteModal(${e.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `,o.appendChild(s);const c=document.createElement("div");c.className="p-4 border-b border-gray-200",c.innerHTML=`
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-gray-800">${e.description}</p>
                            <p class="text-sm text-gray-500">${e.category_name||"N/A"}</p>
                            <p class="text-xs text-gray-400 mt-1">${b(e.transaction_date)}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-red-600">${l(e.amount)}</p>
                            <div class="mt-2">
                                <button onclick="openEditModal(${e.id})" class="text-blue-600 hover:text-blue-800 mr-2"><i class="fas fa-edit"></i></button>
                                <button onclick="openDeleteModal(${e.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    </div>
                `,a.appendChild(c)}),w(t)}catch(n){i(n.message,"error")}}function L(){I.reset(),document.getElementById("modal-title").textContent="Adicionar Nova Saída",document.getElementById("transaction-id").value="",x.classList.remove("hidden")}async function F(n){const t=await fetch(`${r}/api/finance/transactions/${n}/`,{credentials:"include"});if(t.status===401){window.location.href="login.html";return}const a=await t.json();document.getElementById("modal-title").textContent="Editar Saída",document.getElementById("transaction-id").value=a.id,document.getElementById("expense-description").value=a.description,document.getElementById("expense-amount").value=a.amount,document.getElementById("expense-date").value=a.transaction_date,document.getElementById("expense-category").value=a.category,document.getElementById("expense-account").value=a.bank_account,document.getElementById("expense-notes").value=a.notes,x.classList.remove("hidden")}function E(){x.classList.add("hidden")}async function N(n){n.preventDefault();const t=document.getElementById("transaction-id").value,a={description:document.getElementById("expense-description").value,amount:document.getElementById("expense-amount").value,transaction_date:document.getElementById("expense-date").value,category:document.getElementById("expense-category").value,bank_account:document.getElementById("expense-account").value,notes:document.getElementById("expense-notes").value,type:"saida"},o=t?`${r}/api/finance/transactions/${t}/`:`${r}/api/finance/transactions/`,d=t?"PUT":"POST";try{if(!(await fetch(o,{method:d,headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(a)})).ok)throw new Error("Erro ao salvar a despesa.");i(t?"Saída atualizada com sucesso!":"Saída adicionada com sucesso!"),E(),m()}catch(e){i(e.message,"error")}}function H(n){u=n,B.classList.remove("hidden")}function M(){u=null,B.classList.add("hidden")}async function j(){if(u)try{if((await fetch(`${r}/api/finance/transactions/${u}/`,{method:"DELETE",credentials:"include"})).status!==204)throw new Error("Erro ao excluir a despesa.");i("Despesa excluída com sucesso!"),M(),m()}catch(n){i(n.message,"error")}}window.openEditModal=F;window.openDeleteModal=H;document.addEventListener("DOMContentLoaded",m);k.addEventListener("click",L);D.addEventListener("click",L);I.addEventListener("submit",N);document.getElementById("closeModal").addEventListener("click",E);document.getElementById("cancelButton").addEventListener("click",E);document.getElementById("confirm-delete-btn").addEventListener("click",j);document.getElementById("cancel-delete-btn").addEventListener("click",M);
