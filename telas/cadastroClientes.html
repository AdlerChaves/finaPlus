<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Clientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#6B7280',
                        success: '#10B981',
                        danger: '#EF4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 id="page-title" class="text-2xl md:text-3xl font-bold text-gray-800">Cadastro de Clientes</h1>
                <p id="page-subtitle" class="text-gray-600 mt-1">Preencha os dados do cliente abaixo</p>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <button onclick="window.location.href='clientes.html'" class="flex items-center justify-center gap-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition w-full md:w-auto">
                    <i class="fas fa-arrow-left"></i>
                    <span>Voltar para Lista</span>
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px">
                    <button type="button" id="infoTab" class="tab-button active py-4 px-6 text-center border-b-2 font-medium text-sm border-primary text-primary">
                        <i class="fas fa-user mr-2"></i>Informações Básicas
                    </button>
                    <button type="button" id="addressTab" class="tab-button py-4 px-6 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-map-marker-alt mr-2"></i>Endereço (Opcional)
                    </button>
                </nav>
            </div>

            <form id="customerForm" class="p-6">
                <input type="hidden" id="customerId">
                
                <div id="infoContent" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Nome/Razão Social*</label>
                            <input type="text" id="customerName" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                        </div>
                        <div>
                            <label for="customerType" class="block text-sm font-medium text-gray-700 mb-1">Tipo*</label>
                            <select id="customerType" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                <option value="PF">Pessoa Física</option>
                                <option value="PJ">Pessoa Jurídica</option>
                            </select>
                        </div>
                        <div id="documentField">
                            <label id="documentLabel" for="customerDocument" class="block text-sm font-medium text-gray-700 mb-1">CPF*</label>
                            <input type="text" id="customerDocument" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                        </div>
                        <div>
                            <label for="customerPhone" class="block text-sm font-medium text-gray-700 mb-1">Telefone*</label>
                            <input type="tel" id="customerPhone" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                        </div>
                        <div>
                            <label for="customerEmail" class="block text-sm font-medium text-gray-700 mb-1">E-mail*</label>
                            <input type="email" id="customerEmail" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="exemplo@dominio.com">
                        </div>
                        <div id="birthDateField">
                            <label for="customerBirthDate" class="block text-sm font-medium text-gray-700 mb-1">Data de Nascimento</label>
                            <input type="date" id="customerBirthDate" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                        </div>
                        <div>
                            <label for="customerStatus" class="block text-sm font-medium text-gray-700 mb-1">Status*</label>
                            <select id="customerStatus" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                <option value="active">Ativo</option>
                                <option value="inactive">Inativo</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label for="customerNotes" class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                            <textarea id="customerNotes" rows="3" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"></textarea>
                        </div>
                    </div>
                </div>

                <div id="addressContent" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="customerCEP" class="block text-sm font-medium text-gray-700 mb-1">CEP</label>
                            <input type="text" id="customerCEP" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <button type="button" id="searchCEP" class="mt-2 text-xs text-primary hover:underline">Buscar endereço</button>
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label for="customerStreet" class="block text-sm font-medium text-gray-700 mb-1">Logradouro</label>
                            <input type="text" id="customerStreet" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                        </div>
                        <div>
                            <label for="customerNumber" class="block text-sm font-medium text-gray-700 mb-1">Número</label>
                            <input type="text" id="customerNumber" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                        </div>
                        <div>
                            <label for="customerComplement" class="block text-sm font-medium text-gray-700 mb-1">Complemento</label>
                            <input type="text" id="customerComplement" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                        </div>
                        <div>
                            <label for="customerNeighborhood" class="block text-sm font-medium text-gray-700 mb-1">Bairro</label>
                            <input type="text" id="customerNeighborhood" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                        </div>
                        <div>
                            <label for="customerCity" class="block text-sm font-medium text-gray-700 mb-1">Cidade</label>
                            <input type="text" id="customerCity" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                        </div>
                        <div>
                            <label for="customerState" class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                            <select id="customerState" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                <option value="">Selecione</option>
                                <option value="AC">Acre</option>
                                <option value="AL">Alagoas</option>
                                <option value="SP">São Paulo</option>
                                <option value="SE">Sergipe</option>
                                <option value="TO">Tocantins</option>
                            </select>
                        </div>
                        <div>
                            <label for="customerCountry" class="block text-sm font-medium text-gray-700 mb-1">País</label>
                            <input type="text" id="customerCountry" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" value="Brasil">
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex flex-col sm:flex-row justify-end gap-3 border-t border-gray-200 pt-6">
                    <button type="button" id="previousTab" class="hidden px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">
                        <i class="fas fa-arrow-left mr-2"></i>Anterior
                    </button>
                    <button type="button" id="nextTab" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 transition">
                        Próximo<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                    <button type="submit" id="saveButton" class="px-4 py-2 bg-success text-white rounded-md hover:bg-green-600 transition">
                        <i class="fas fa-save mr-2"></i>Salvar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="hidden fixed bottom-5 right-5 px-5 py-3 rounded-lg shadow-lg text-white">
        <span id="toast-message"></span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const API_URL = 'http://127.0.0.1:8000'; // Ajuste se necessário
            const token = localStorage.getItem('accessToken');
            const customerId = new URLSearchParams(window.location.search).get('id');
            const form = document.getElementById('customerForm');

            // --- LÓGICA DE INICIALIZAÇÃO (CRIAR vs EDITAR) ---
            const initialize = () => {
                setupEventListeners();
                if (customerId) {
                    prepareEditMode(customerId);
                } else {
                    prepareCreateMode();
                }
            };

            const prepareCreateMode = () => {
                document.getElementById('page-title').textContent = 'Cadastro de Clientes';
                document.getElementById('page-subtitle').textContent = 'Preencha os dados do novo cliente';
            };

            const prepareEditMode = async (id) => {
                document.getElementById('page-title').textContent = 'Editar Cliente';
                document.getElementById('page-subtitle').textContent = 'Altere os dados do cliente abaixo';
                document.getElementById('saveButton').innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Alterações';

                try {
                    const response = await fetch(`${API_URL}/api/cadastros/customers/${id}/`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Não foi possível carregar os dados do cliente.');
                    const customer = await response.json();
                    populateForm(customer);
                } catch (error) {
                    showToast(error.message, 'error');
                    setTimeout(() => window.location.href = 'clientes.html', 2000);
                }
            };

            const populateForm = (customer) => {
                document.getElementById('customerId').value = customer.id;
                document.getElementById('customerName').value = customer.name;
                document.getElementById('customerType').value = customer.customer_type;
                document.getElementById('customerDocument').value = customer.document;
                document.getElementById('customerPhone').value = customer.phone;
                document.getElementById('customerEmail').value = customer.email;
                document.getElementById('customerStatus').value = customer.status;
                document.getElementById('customerBirthDate').value = customer.birth_date || '';
                document.getElementById('customerNotes').value = customer.notes || '';
                
                if (customer.address) {
                    document.getElementById('customerCEP').value = customer.address.cep || '';
                    document.getElementById('customerStreet').value = customer.address.street || '';
                    document.getElementById('customerNumber').value = customer.address.number || '';
                    document.getElementById('customerComplement').value = customer.address.complement || '';
                    document.getElementById('customerNeighborhood').value = customer.address.neighborhood || '';
                    document.getElementById('customerCity').value = customer.address.city || '';
                    document.getElementById('customerState').value = customer.address.state || '';
                    document.getElementById('customerCountry').value = customer.address.country || 'Brasil';
                }
                // Dispara o evento 'change' para ajustar a UI (CPF/CNPJ)
                document.getElementById('customerType').dispatchEvent(new Event('change'));
            };

            // --- LÓGICA DE EVENTOS ---
            const setupEventListeners = () => {
                // Navegação por abas
                const infoTab = document.getElementById('infoTab');
                const addressTab = document.getElementById('addressTab');
                const nextTabBtn = document.getElementById('nextTab');
                const prevTabBtn = document.getElementById('previousTab');
                
                infoTab.addEventListener('click', () => switchTab('info'));
                addressTab.addEventListener('click', () => switchTab('address'));
                nextTabBtn.addEventListener('click', () => {
                    if (validateBasicInfo()) switchTab('address');
                });
                prevTabBtn.addEventListener('click', () => switchTab('info'));

                // Mudança de tipo de cliente (PF/PJ)
                document.getElementById('customerType').addEventListener('change', handleCustomerTypeChange);
                
                // Busca por CEP
                document.getElementById('searchCEP').addEventListener('click', searchCEP);

                // Submissão do formulário
                form.addEventListener('submit', handleFormSubmit);
            };

            const switchTab = (tabName) => {
                const isInfo = tabName === 'info';
                document.getElementById('infoTab').classList.toggle('active', isInfo);
                document.getElementById('addressTab').classList.toggle('active', !isInfo);
                document.getElementById('infoContent').classList.toggle('hidden', !isInfo);
                document.getElementById('addressContent').classList.toggle('hidden', isInfo);
                document.getElementById('previousTab').classList.toggle('hidden', isInfo);
                document.getElementById('nextTab').classList.toggle('hidden', !isInfo);
            };

            const handleCustomerTypeChange = (e) => {
                const isPJ = e.target.value === 'PJ';
                document.getElementById('documentLabel').textContent = isPJ ? 'CNPJ*' : 'CPF*';
                document.getElementById('birthDateField').classList.toggle('hidden', isPJ);
            };

            const searchCEP = async () => {
                const cep = document.getElementById('customerCEP').value.replace(/\D/g, '');
                if (cep.length !== 8) return showToast('CEP inválido.', 'error');
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    if (!response.ok || response.erro) throw new Error();
                    const data = await response.json();
                    populateAddressFields(data);
                } catch {
                    showToast('CEP não encontrado.', 'error');
                }
            };
            
            const populateAddressFields = (data) => {
                document.getElementById('customerStreet').value = data.logradouro;
                document.getElementById('customerNeighborhood').value = data.bairro;
                document.getElementById('customerCity').value = data.localidade;
                document.getElementById('customerState').value = data.uf;
            };

            // --- SUBMISSÃO E VALIDAÇÃO ---
            const handleFormSubmit = async (e) => {
                e.preventDefault();
                if (!validateBasicInfo()) {
                    switchTab('info');
                    return;
                }

                const id = document.getElementById('customerId').value;
                const url = id ? `${API_URL}/api/cadastros/customers/${id}/` : `${API_URL}/api/cadastros/customers/`;
                const method = id ? 'PUT' : 'POST';

                const payload = {
                    name: document.getElementById('customerName').value,
                    customer_type: document.getElementById('customerType').value,
                    document: document.getElementById('customerDocument').value,
                    phone: document.getElementById('customerPhone').value,
                    email: document.getElementById('customerEmail').value,
                    birth_date: document.getElementById('customerBirthDate').value || null,
                    status: document.getElementById('customerStatus').value,
                    notes: document.getElementById('customerNotes').value,
                    address: null
                };

                const cep = document.getElementById('customerCEP').value;
                if (cep) {
                    payload.address = {
                        cep: cep,
                        street: document.getElementById('customerStreet').value,
                        number: document.getElementById('customerNumber').value,
                        complement: document.getElementById('customerComplement').value,
                        neighborhood: document.getElementById('customerNeighborhood').value,
                        city: document.getElementById('customerCity').value,
                        state: document.getElementById('customerState').value,
                        country: document.getElementById('customerCountry').value
                    };
                }

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorMessage = Object.entries(errorData).map(([key, value]) => `${key}: ${value.join(', ')}`).join('; ');
                        throw new Error(errorMessage || 'Erro ao salvar os dados.');
                    }
                    showToast('Cliente salvo com sucesso!', 'success');
                    setTimeout(() => window.location.href = 'clientes.html', 1500);
                } catch (error) {
                    showToast(error.message, 'error');
                }
            };
            
            const validateBasicInfo = () => {
                const required = ['customerName', 'customerType', 'customerDocument', 'customerPhone', 'customerEmail', 'customerStatus'];
                for (const id of required) {
                    if (!document.getElementById(id).value) {
                        showToast(`O campo "${document.getElementById(id).previousElementSibling.textContent}" é obrigatório.`, 'error');
                        return false;
                    }
                }
                return true;
            };

            // Inicia a aplicação
            initialize();
        });

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toast.className = `fixed bottom-5 right-5 px-5 py-3 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
</body>
</html>